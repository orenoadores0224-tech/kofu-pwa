<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>受験護符</title>
  <meta name="theme-color" content="#0b0b0f" />
  <link rel="icon" href="./icon-192.png" />
  <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
  <style>
    :root{
      --bg:#07070b;
      --panel:rgba(16,16,22,.74);
      --line:rgba(255,255,255,.10);
      --txt:rgba(255,255,255,.92);
      --sub:rgba(255,255,255,.60);
      --accent:#8b1b1b;
      --r:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--txt);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(139,27,27,.22), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(255,214,120,.10), transparent 55%),
        var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
      min-height:100svh;
    }
    .wrap{max-width:820px;margin:0 auto;padding:18px 16px 28px;}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:6px 2px 14px;border-bottom:1px solid rgba(255,255,255,.06);
    }
    a.back{
      color:rgba(255,255,255,.70);
      text-decoration:none;
      font-weight:700;
      letter-spacing:.06em;
    }
    .right{color:rgba(255,255,255,.35);font-weight:800;letter-spacing:.24em}
    h1{margin:14px 2px 6px;font-size:28px;letter-spacing:.06em}
    .lead{margin:0 2px 14px;color:var(--sub);line-height:1.65}

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--r);
      overflow:hidden;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .inner{padding:16px}
    .label{font-weight:800;letter-spacing:.06em;margin:0 0 10px}
    .photo{
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      overflow:hidden;
      background:rgba(0,0,0,.22);
    }
    /* 以前の並び（自然比率）に戻す：height固定しない */
    .photo img{
      display:block;
      width:100%;
      height:auto;         /* ←ズレ/トリミングの元を消す */
      object-fit:contain;  /* 念のため */
      background:rgba(0,0,0,.22);
    }
    .row{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      margin-top:12px;
    }
    .file{
      display:flex;align-items:center;gap:10px;flex:1;
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;border-radius:12px;
      background:rgba(0,0,0,.18);
    }
    input[type="file"]{width:100%}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      color:rgba(255,255,255,.92);
      border-radius:12px;
      padding:12px 14px;
      font-weight:900;
      letter-spacing:.10em;
      cursor:pointer;
    }
    .btn.primary{
      border-color:rgba(139,27,27,.55);
      box-shadow:0 0 0 1px rgba(139,27,27,.30) inset;
    }
    .note{
      margin-top:12px;color:rgba(255,255,255,.52);font-size:12px;line-height:1.6;
    }

    /* 金粉（控えめ） */
    #dust{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.50}
    .wrap, .card{position:relative;z-index:1}
  </style>
</head>
<body>
<canvas id="dust"></canvas>

<div class="wrap">
  <div class="top">
    <a class="back" href="./index.html">← 護符にもどる</a>
    <div class="right">JUKE(N)</div>
  </div>

  <h1>受験護符（親の静けさ）</h1>
  <p class="lead">公開テストOK。ここは「親が静かでいる」ための封入。</p>

  <section class="card">
    <div class="inner">
      <div class="label">受験護符の写真</div>

      <div class="photo">
        <img id="preview" alt="preview" src="" />
      </div>

      <div class="row">
        <div class="file">
          <span style="color:rgba(255,255,255,.55);font-weight:800;letter-spacing:.08em;">写真</span>
          <input id="file" type="file" accept="image/*" />
        </div>
        <button class="btn primary" id="seal">封入（封印）</button>
      </div>

      <div class="note">
        ・「写真が違う」問題は <b>固定サンプルをやめて</b>、毎回アップした写真だけを表示するように修正済み。<br/>
        ・封入ボタンは儀式用（音/振動は必要なら後で追加できる）。
      </div>
    </div>
  </section>

  <div style="margin-top:14px;">
    <a class="back" href="./index.html">← もどる</a>
  </div>
</div>

<script>
  // 画像：固定ファイルを使わず、アップした画像だけ表示（=写真違いを防ぐ）
  const file = document.getElementById('file');
  const preview = document.getElementById('preview');

  // 前回の選択を残す（PWAで便利）
  const KEY = 'juken_last_image';
  const saved = localStorage.getItem(KEY);
  if(saved){
    preview.src = saved;
  } else {
    // 初期は空（変な画像を勝手に出さない）
    preview.src = '';
    preview.style.display = 'none';
  }

  file.addEventListener('change', () => {
    const f = file.files && file.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      preview.src = reader.result;
      preview.style.display = 'block';
      localStorage.setItem(KEY, reader.result);
    };
    reader.readAsDataURL(f);
  });

  document.getElementById('seal').addEventListener('click', () => {
    // ここは“儀式トリガー”として最低限
    if(!preview.src){
      alert('写真を選択してください');
      return;
    }
    // ちょい演出（控えめ）
    navigator.vibrate && navigator.vibrate([30,30,60]);
    alert('封入しました');
  });

  // 金粉（控えめ）
  (function(){
    const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if(reduce) return;
    const c = document.getElementById('dust');
    const ctx = c.getContext('2d');
    let w,h,dpr;
    function resize(){
      dpr = Math.min(2, devicePixelRatio||1);
      w = c.width = Math.floor(innerWidth*dpr);
      h = c.height = Math.floor(innerHeight*dpr);
      c.style.width = innerWidth+'px';
      c.style.height = innerHeight+'px';
    }
    addEventListener('resize', resize, {passive:true});
    resize();

    const N = Math.max(16, Math.min(60, Math.floor((innerWidth*innerHeight)/32000)));
    const ps = Array.from({length:N}, () => ({
      x: Math.random()*w, y: Math.random()*h,
      r: (Math.random()*1.2+0.5)*dpr,
      vx:(Math.random()*0.16+0.03)*dpr,
      vy:(Math.random()*0.12+0.04)*dpr,
      a: Math.random()*0.40+0.10
    }));
    function tick(){
      ctx.clearRect(0,0,w,h);
      for(const p of ps){
        p.x+=p.vx; p.y+=p.vy;
        if(p.x>w+20) p.x=-20;
        if(p.y>h+20) p.y=-20;
        ctx.beginPath();
        ctx.fillStyle=`rgba(255,214,120,${p.a})`;
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fill();
      }
      requestAnimationFrame(tick);
    }
    tick();
  })();
</script>
</body>
</html>